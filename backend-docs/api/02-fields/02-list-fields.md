# GET /api/fields

## Genel Bakış
Kullanıcının erişebileceği tüm field'ları listeler. Global (sistem) field'lar ve kullanıcının oluşturduğu custom field'ları döner. İsteğe bağlı olarak category ve is_system filtrelemeleri yapılabilir.

## Endpoint Bilgileri
- **Method:** GET
- **Path:** `/api/fields`
- **Authentication:** JWT Token gerekli
- **Response Status:** 200 OK

## Request Format

### Query Parameters
| Parametre | Tip | Zorunlu | Açıklama |
|-----------|-----|---------|----------|
| category | string | Hayır | Kategori ile filtrele (örn: "Contact Info", "Business", "System") |
| is_system | boolean | Hayır | Sistem field'larını filtrele (true = sadece sistem, false = sadece custom) |

### Örnek Requestler
```bash
# Tüm field'ları listele
GET /api/fields

# Sadece Contact Info kategorisindeki field'lar
GET /api/fields?category=Contact Info

# Sadece sistem field'ları
GET /api/fields?is_system=true

# Sadece custom (kullanıcı) field'ları
GET /api/fields?is_system=false

# Contact Info kategorisindeki custom field'lar
GET /api/fields?category=Contact Info&is_system=false
```

## Response Format

### Success Response (200 OK)
```json
[
  {
    "id": "fld_created_at",
    "name": "created_at",
    "label": "Created At",
    "type": "datetime",
    "description": "Record creation timestamp",
    "category": "System",
    "is_global": true,
    "is_system_field": true,
    "is_custom": false,
    "config": {
      "readonly": true,
      "autoGenerated": true
    },
    "created_by": null,
    "created_at": "2026-01-01T00:00:00Z",
    "updated_at": "2026-01-01T00:00:00Z"
  },
  {
    "id": "fld_a1b2c3d4",
    "name": "email",
    "label": "Email Address",
    "type": "email",
    "description": "Contact email address",
    "category": "Contact Info",
    "is_global": false,
    "is_system_field": false,
    "is_custom": true,
    "config": {
      "validation": {
        "required": true,
        "regex": "^[^@]+@[^@]+\\.[^@]+$"
      },
      "placeholder": "user@example.com"
    },
    "created_by": "550e8400-e29b-41d4-a716-446655440000",
    "created_at": "2026-01-18T10:00:00Z",
    "updated_at": "2026-01-18T10:00:00Z"
  }
]
```

### Response Schema (Array of FieldResponse)
| Alan | Tip | Açıklama |
|------|-----|----------|
| id | string | Field ID (fld_xxxxxxxx) |
| name | string | Field adı |
| label | string | Görünen ad |
| type | string | Field tipi |
| description | string \| null | Field açıklaması |
| category | string \| null | Kategori |
| is_global | boolean | Global field mi? |
| is_system_field | boolean | Sistem field'ı mı? |
| is_custom | boolean | Custom field mi? |
| config | object | Field konfigürasyonu |
| created_by | string \| null | Oluşturan kullanıcı UUID (sistem field'larında null, JSON'da string formatında) |
| created_at | string (datetime) | Oluşturulma zamanı |
| updated_at | string (datetime) | Son güncelleme zamanı |

### Error Responses

#### 401 Unauthorized - JWT Token Eksik/Geçersiz
```json
{
  "detail": "Not authenticated"
}
```

## Kod Akışı

### 1. Router Layer
**Dosya:** `app/routers/fields.py`

```python
@router.get("/", response_model=list[FieldResponse])
async def list_fields(
    category: str | None = Query(None, description="Filter by category"),
    is_system: bool | None = Query(None, description="Filter system fields"),
    db: AsyncSession = Depends(get_db),
    user_id: str = Depends(get_current_user_id),
):
    fields = await field_service.get_fields(db, user_id, category, is_system)
    return fields
```

**Görevleri:**
- Query parametreleri alır (category, is_system - her ikisi de opsiyonel)
- JWT token'dan user_id'yi çıkarır
- Service layer'ı çağırır
- Response'u `list[FieldResponse]` olarak döner

### 2. Service Layer
**Dosya:** `app/services/field_service.py`

```python
async def get_fields(
    self,
    db: AsyncSession,
    user_id: uuid.UUID,
    category: str | None = None,
    is_system: bool | None = None,
) -> list[Field]:
    """Get fields (global + user's own), optionally filter by category and system"""
    query = select(Field).where(
        or_(
            Field.is_global == True,
            Field.created_by == user_id
        )
    )

    # Filter by category if provided
    if category:
        query = query.where(Field.category == category)

    # Filter by system fields if provided
    if is_system is not None:
        query = query.where(Field.is_system_field == is_system)

    result = await db.execute(query)
    return list(result.scalars().all())
```

**Business Logic:**
1. **Base Query:** Global field'lar OR kullanıcının kendi field'ları
2. **Category Filter:** Eğer category parametresi varsa filtrele
3. **System Filter:** Eğer is_system parametresi varsa filtrele
4. Query'yi execute et ve list olarak döndür

### 3. Database Layer
**SQL Query (SQLAlchemy tarafından oluşturulur):**

```sql
-- Tüm field'lar (category ve is_system filtresi YOK)
SELECT * FROM fields
WHERE is_global = true OR created_by = '550e8400-e29b-41d4-a716-446655440000';

-- Category filtresi ile
SELECT * FROM fields
WHERE (is_global = true OR created_by = '550e8400-e29b-41d4-a716-446655440000')
  AND category = 'Contact Info';

-- is_system filtresi ile (sadece sistem field'ları)
SELECT * FROM fields
WHERE (is_global = true OR created_by = '550e8400-e29b-41d4-a716-446655440000')
  AND is_system_field = true;

-- İkisi birlikte
SELECT * FROM fields
WHERE (is_global = true OR created_by = '550e8400-e29b-41d4-a716-446655440000')
  AND category = 'Contact Info'
  AND is_system_field = false;
```

**Index Kullanımı:**
- `idx_fields_is_global`: Global field filtreleme
- `idx_fields_created_by`: User field filtreleme
- `idx_fields_category`: Category filtreleme
- `idx_fields_is_system`: System field filtreleme

## Kullanım Örnekleri

### cURL
```bash
# Tüm field'ları listele
curl -X GET http://localhost:8000/api/fields \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

# Sadece Contact Info kategorisi
curl -X GET "http://localhost:8000/api/fields?category=Contact%20Info" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

# Sadece sistem field'ları
curl -X GET "http://localhost:8000/api/fields?is_system=true" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

# Sadece custom field'lar
curl -X GET "http://localhost:8000/api/fields?is_system=false" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### Python (httpx)
```python
import httpx

token = "YOUR_JWT_TOKEN"

# Tüm field'ları listele
response = httpx.get(
    "http://localhost:8000/api/fields",
    headers={"Authorization": f"Bearer {token}"}
)

if response.status_code == 200:
    fields = response.json()
    print(f"Total fields: {len(fields)}")
    for field in fields:
        print(f"- {field['label']} ({field['type']})")

# Category filtresi ile
response = httpx.get(
    "http://localhost:8000/api/fields",
    params={"category": "Contact Info"},
    headers={"Authorization": f"Bearer {token}"}
)

# System field'ları filtrele
response = httpx.get(
    "http://localhost:8000/api/fields",
    params={"is_system": True},
    headers={"Authorization": f"Bearer {token}"}
)
```

### JavaScript (fetch)
```javascript
const token = "YOUR_JWT_TOKEN";

// Tüm field'ları listele
const response = await fetch('http://localhost:8000/api/fields', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
});

if (response.ok) {
  const fields = await response.json();
  console.log(`Total fields: ${fields.length}`);
  fields.forEach(field => {
    console.log(`- ${field.label} (${field.type})`);
  });
}

// Category filtresi ile
const contactFields = await fetch(
  'http://localhost:8000/api/fields?category=Contact Info',
  {
    headers: { 'Authorization': `Bearer ${token}` }
  }
);

// Sadece custom field'lar
const customFields = await fetch(
  'http://localhost:8000/api/fields?is_system=false',
  {
    headers: { 'Authorization': `Bearer ${token}` }
  }
);
```

## Field Kategorileri

| Kategori | Açıklama | Örnek Field'lar |
|----------|----------|-----------------|
| System | Sistem field'ları | created_at, created_by, owner, updated_at |
| Contact Info | İletişim bilgileri | email, phone, mobile, fax |
| Business | İş bilgileri | company, job_title, department |
| Address | Adres bilgileri | street, city, state, zip_code, country |
| Custom | Özel kategoriler | Kullanıcı tanımlı |

## Filtreleme Örnekleri

### 1. Global vs User Fields
```python
# Global field'lar (tüm kullanıcılar için)
is_global = True, created_by = null

# User custom field'lar
is_global = False, created_by = <user_id>
```

### 2. System vs Custom Fields
```python
# System field'lar (created_at, owner vb.)
is_system_field = True

# Custom field'lar (kullanıcı oluşturdu)
is_system_field = False, is_custom = True
```

### 3. Kategori Bazlı
```python
# Contact Info kategorisi
category = "Contact Info"

# Business kategorisi
category = "Business"
```

## Performance Notları

1. **Index Kullanımı:**
   - Query'ler index'leri kullanır (is_global, created_by, category)
   - Hızlı response (~10-50ms)

2. **Pagination:**
   - Şu anda pagination yok (tüm field'lar döner)
   - TODO: Çok fazla field varsa pagination eklenebilir

3. **Cache:**
   - Global field'lar nadiren değişir, cache'lenebilir
   - TODO: Redis cache ile optimize edilebilir

## İlgili Endpoint'ler

- [POST /api/fields](01-create-field.md) - Yeni field oluştur
- [GET /api/fields/{field_id}](03-get-field.md) - Tek field getir
- [PATCH /api/fields/{field_id}](04-update-field.md) - Field güncelle
- [DELETE /api/fields/{field_id}](05-delete-field.md) - Field sil
